{% extends 'grc_dashboard/base.html' %}

{% block title %}Executive Dashboard - ICARIS{% endblock %}

{% block nav_dashboard %}active{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1>Executive Dashboard</h1>
        <p class="subtitle">System-wide compliance posture and risk overview.</p>
    </div>
    <div class="header-actions">
        <button class="btn-export">
            <i class="fas fa-download"></i> Export Report
        </button>
        <button class="btn-primary-custom">
            <i class="fas fa-cog"></i> Manage RFIs
        </button>
    </div>
</div>

<!-- Metrics Grid -->
<div class="metrics-grid">
    <div class="metric-card">
        <div class="metric-header">
            <div>
                <div class="metric-title">Compliance Score</div>
            </div>
            <div class="metric-icon blue">
                <i class="fas fa-chart-line"></i>
            </div>
        </div>
        <div class="metric-value">{{ compliance_rate|floatformat:0 }}%</div>
        <div class="metric-footer">
            <span class="metric-change positive">
                <i class="fas fa-arrow-up"></i> +2%
            </span>
            <span class="metric-label">vs. last month</span>
        </div>
    </div>

    <div class="metric-card">
        <div class="metric-header">
            <div>
                <div class="metric-title">Open PO&AMs</div>
            </div>
            <div class="metric-icon orange">
                <i class="fas fa-clipboard-list"></i>
            </div>
        </div>
        <div class="metric-value">{{ open_issues }}</div>
        <div class="metric-footer">
            <span class="metric-change negative">
                <i class="fas fa-arrow-down"></i> -1
            </span>
            <span class="metric-label">Requires attention</span>
        </div>
    </div>

    <div class="metric-card">
        <div class="metric-header">
            <div>
                <div class="metric-title">Pending RFIs</div>
            </div>
            <div class="metric-icon red">
                <i class="fas fa-exclamation-circle"></i>
            </div>
        </div>
        <div class="metric-value">{{ critical_risks }}</div>
        <div class="metric-footer">
            <span class="metric-change neutral">
                <i class="fas fa-minus"></i> 0
            </span>
            <span class="metric-label">Awaiting artifacts</span>
        </div>
    </div>

    <div class="metric-card">
        <div class="metric-header">
            <div>
                <div class="metric-title">Total Systems</div>
            </div>
            <div class="metric-icon green">
                <i class="fas fa-server"></i>
            </div>
        </div>
        <div class="metric-value">{{ total_controls|add:4 }}</div>
        <div class="metric-footer">
            <span class="metric-change positive">
                <i class="fas fa-arrow-up"></i> +1
            </span>
            <span class="metric-label">{{ total_controls }} Compliant</span>
        </div>
    </div>
</div>

<!-- Charts Grid -->
<div class="charts-grid">
    <div class="chart-card">
        <div class="chart-header">
            <div class="chart-title">RFI & PO&AM Activity</div>
            <div class="chart-subtitle">6-month trend of items opened vs closed</div>
        </div>
        <div class="chart-container">
            <canvas id="activityChart"></canvas>
        </div>
    </div>

    <div class="chart-card">
        <div class="chart-header">
            <div class="chart-title">Risk Distribution</div>
            <div class="chart-subtitle">Current open items by risk level</div>
        </div>
        <div class="chart-container">
            <canvas id="riskChart"></canvas>
        </div>
    </div>
</div>

<!-- Recent Action Items Table -->
<div class="table-card">
    <div class="table-header">
        <div>
            <div class="table-title">Recent Action Items</div>
            <div class="table-subtitle">Latest updates across all systems</div>
        </div>
        <a href="{% url 'risk_register' %}" class="view-all-link">View All</a>
    </div>
    <table class="custom-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Title</th>
                <th>System</th>
                <th>Status</th>
                <th>Risk</th>
                <th>Due Date</th>
            </tr>
        </thead>
        <tbody>
            {% for risk in recent_risks %}
            <tr>
                <td><strong>{{ risk.id }}</strong></td>
                <td>{{ risk.title }}</td>
                <td>{{ risk.department.name }}</td>
                <td>
                    <span class="status-badge {% if risk.status == 'closed' %}completed{% elif risk.status == 'open' %}pending{% else %}critical{% endif %}">
                        {{ risk.get_status_display }}
                    </span>
                </td>
                <td>
                    <span class="status-badge {{ risk.severity }}">
                        {{ risk.get_severity_display }}
                    </span>
                </td>
                <td>{{ risk.target_closure_date|default:"N/A" }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6">
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>No recent action items to display</p>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Activity Chart (Bar Chart)
    const activityCtx = document.getElementById('activityChart').getContext('2d');
    new Chart(activityCtx, {
        type: 'bar',
        data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
            datasets: [{
                label: 'Opened',
                data: [4, 3, 6, 2, 5, 3],
                backgroundColor: '#2563eb',
                borderRadius: 6,
                barThickness: 24,
            }, {
                label: 'Closed',
                data: [2, 5, 3, 4, 6, 2],
                backgroundColor: '#d1d5db',
                borderRadius: 6,
                barThickness: 24,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    border: {
                        display: false
                    },
                    grid: {
                        color: '#f5f5f7'
                    }
                },
                x: {
                    border: {
                        display: false
                    },
                    grid: {
                        display: false
                    }
                }
            }
        }
    });

    // Risk Distribution (Doughnut Chart) - WITH REAL DATA
    const riskCtx = document.getElementById('riskChart').getContext('2d');

    // Build data from Django context
    const riskData = {
        'low': 0,
        'medium': 0,
        'high': 0,
        'critical': 0
    };

    // Populate from server data
    {% for item in risks_by_severity %}
        riskData['{{ item.severity }}'] = {{ item.count }};
    {% endfor %}

    new Chart(riskCtx, {
        type: 'doughnut',
        data: {
            labels: ['Low', 'Moderate', 'High', 'Critical'],
            datasets: [{
                data: [
                    riskData.low,
                    riskData.medium,
                    riskData.high,
                    riskData.critical
                ],
                backgroundColor: [
                    '#22c55e',
                    '#f97316',
                    '#ef4444',
                    '#991b1b'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '75%',
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                }
            }
        },
        plugins: [{
            id: 'centerText',
            beforeDraw: function(chart) {
                const width = chart.width;
                const height = chart.height;
                const ctx = chart.ctx;
                ctx.restore();
                const fontSize = (height / 160).toFixed(2);
                ctx.font = fontSize + "em sans-serif";
                ctx.textBaseline = "middle";
                const text = "{{ open_risks }}";
                const textX = Math.round((width - ctx.measureText(text).width) / 2);
                const textY = height / 2 - 10;
                ctx.fillStyle = '#1d1d1f';
                ctx.font = 'bold ' + (fontSize * 2) + 'em sans-serif';
                ctx.fillText(text, textX, textY);
                
                ctx.font = (fontSize * 0.6) + 'em sans-serif';
                ctx.fillStyle = '#86868b';
                const subText = "OPEN RISKS";
                const subTextX = Math.round((width - ctx.measureText(subText).width) / 2);
                ctx.fillText(subText, subTextX, textY + 30);
                ctx.save();
            }
        }]
    });
</script>
{% endblock %}