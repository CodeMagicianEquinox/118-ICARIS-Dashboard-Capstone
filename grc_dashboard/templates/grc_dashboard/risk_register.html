{% extends 'grc_dashboard/base.html' %}

{% block title %}ConMons - ICARIS{% endblock %}

{% block nav_conmons %}active{% endblock %}

{% block extra_css %}
/* Risk Heatmap Styles */
.heatmap-card {
    background: white;
    border-radius: 12px;
    padding: 32px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    margin-bottom: 32px;
}

.heatmap-header {
    margin-bottom: 32px;
    text-align: center;
}

.heatmap-title {
    font-size: 20px;
    font-weight: 600;
    color: #1d1d1f;
    margin-bottom: 8px;
}

.heatmap-subtitle {
    font-size: 14px;
    color: #86868b;
}

.heatmap-grid {
    display: grid;
    grid-template-columns: 100px repeat(5, 1fr);
    grid-template-rows: 80px repeat(5, 1fr);
    gap: 8px;
    max-width: 900px;
    margin: 0 auto;
}

.heatmap-cell {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100px;
    border-radius: 8px;
    position: relative;
    transition: all 0.2s;
}

.heatmap-cell.label {
    background: transparent;
    color: #86868b;
    font-size: 13px;
    font-weight: 600;
    text-align: center;
}

.heatmap-cell.label small {
    display: block;
    font-size: 11px;
    margin-top: 4px;
}

.heatmap-cell.empty {
    background: transparent;
}

.heatmap-cell.low {
    background: #22c55e;
    color: white;
    cursor: pointer;
}

.heatmap-cell.medium {
    background: #f97316;
    color: white;
    cursor: pointer;
}

.heatmap-cell.high {
    background: #ef4444;
    color: white;
    cursor: pointer;
}

.heatmap-cell.critical {
    background: #991b1b;
    color: white;
    cursor: pointer;
}

.heatmap-cell:not(.label):not(.empty):hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 10;
}

.risk-count-badge {
    position: absolute;
    top: 8px;
    right: 8px;
    background: rgba(0, 0, 0, 0.3);
    color: white;
    border-radius: 12px;
    padding: 4px 10px;
    font-size: 12px;
    font-weight: 600;
}

.heatmap-legend {
    text-align: center;
    margin-top: 24px;
    color: #86868b;
    font-size: 13px;
}

/* Compliance Bar Styles */
.compliance-bar-container {
    width: 100%;
    max-width: 200px;
    height: 24px;
    background: #f5f5f7;
    border-radius: 12px;
    overflow: hidden;
    position: relative;
}

.compliance-bar {
    height: 100%;
    border-radius: 12px;
    transition: width 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
    color: white;
}

.compliance-bar.high {
    background: linear-gradient(90deg, #22c55e 0%, #16a34a 100%);
}

.compliance-bar.medium {
    background: linear-gradient(90deg, #f97316 0%, #ea580c 100%);
}

.compliance-bar.low {
    background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
}

.status-badge-compliant {
    background: rgba(34, 197, 94, 0.1);
    color: #16a34a;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
}

.status-badge-noncompliant {
    background: rgba(239, 68, 68, 0.1);
    color: #dc2626;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
}

@media (max-width: 768px) {
    .heatmap-grid {
        grid-template-columns: 60px repeat(5, 1fr);
        font-size: 12px;
    }
}
{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1>Continuous Monitoring (ConMons)</h1>
        <p class="subtitle">Track compliance requirements and evidence uploads.</p>
    </div>
</div>

<!-- Stats Grid -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon blue">
            <i class="fas fa-clipboard-check"></i>
        </div>
        <div class="stat-value">{{ total_risks }}</div>
        <div class="stat-label">Total Requirements</div>
    </div>

    <div class="stat-card">
        <div class="stat-icon green">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-value">{{ compliant_count }}</div>
        <div class="stat-label">Compliant</div>
    </div>

    <div class="stat-card">
        <div class="stat-icon red">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="stat-value">{{ noncompliant_count }}</div>
        <div class="stat-label">Non-Compliant</div>
    </div>

    <div class="stat-card">
        <div class="stat-icon orange">
            <i class="fas fa-percentage"></i>
        </div>
        <div class="stat-value">{{ avg_compliance }}%</div>
        <div class="stat-label">Avg Compliance</div>
    </div>
</div>

<!-- Risk Heatmap -->
<div class="heatmap-card">
    <div class="heatmap-header">
        <div class="heatmap-title">Risk Heat Matrix</div>
        <div class="heatmap-subtitle">5x5 matrix showing likelihood vs. impact assessment</div>
    </div>
    
    <div class="heatmap-grid">
        <!-- Top left empty cell -->
        <div class="heatmap-cell empty"></div>
        
        <!-- Impact labels (top row) -->
        <div class="heatmap-cell label">
            <div>1</div>
            <small>Negligible</small>
        </div>
        <div class="heatmap-cell label">
            <div>2</div>
            <small>Minor</small>
        </div>
        <div class="heatmap-cell label">
            <div>3</div>
            <small>Moderate</small>
        </div>
        <div class="heatmap-cell label">
            <div>4</div>
            <small>Major</small>
        </div>
        <div class="heatmap-cell label">
            <div>5</div>
            <small>Severe</small>
        </div>
        
        <!-- Row 5: Almost Certain -->
        <div class="heatmap-cell label">
            <div>5</div>
            <small>Almost Certain</small>
        </div>
        <div class="heatmap-cell medium" id="cell-5-1" data-score="5">
            <span class="risk-count-badge" style="display:none;">0</span>
        </div>
        <div class="heatmap-cell high" id="cell-5-2" data-score="10">
            <span class="risk-count-badge" style="display:none;">0</span>
        </div>
        <div class="heatmap-cell high" id="cell-5-3" data-score="15">
            <span class="risk-count-badge" style="display:none;">0</span>
        </div>
        <div class="heatmap-cell critical" id="cell-5-4" data-score="20">
            <span class="risk-count-badge" style="display:none;">0</span>
        </div>
        <div class="heatmap-cell critical" id="cell-5-5" data-score="25">
            <span class="risk-count-badge" style="display:none;">0</span>
        </div>
        
        <!-- Row 4: Likely -->
        <div class="heatmap-cell label">
            <div>4</div>
            <small>Likely</small>
        </div>
        <div class="heatmap-cell medium" id="cell-4-1" data-score="4">
            <span class="risk-count-badge" style="display:none;">0</span>
        </div>
        <div class="heatmap-cell medium" id="cell-4-2" data-score="8">
            <span class="risk-count-badge" style="display:none;">0</span>
        </div>
        <div class="heatmap-cell high" id="cell-4-3" data-score="12">
            <span class="risk-count-badge" style="display:none;">0</span>
        </div>
        <div class="heatmap-cell high" id="cell-4-4" data-score="16">
            <span class="risk-count-badge" style="display:none;">0</span>
        </div>
        <div class="heatmap-cell critical" id="cell-4-5" data-score="20">
            <span class="risk-count-badge" style="display:none;">0</span>
        </div>
        
        <!-- Row 3: Possible -->
        <div class="heatmap-cell label">
            <div>3</div>
            <small>Possible</small>
        </div>
        <div class="heatmap-cell low" id="cell-3-1" data-score="3">
            <span class="risk-count-badge" style="display:none;">0</span>
        </div>
        <div class="heatmap-cell medium" id="cell-3-2" data-score="6">
            <span class="risk-count-badge" style="display:none;">0</span>
        </div>
        <div class="heatmap-cell medium" id="cell-3-3" data-score="9">
            <span class="risk-count-badge" style="display:none;">0</span>
        </div>
        <div class="heatmap-cell high" id="cell-3-4" data-score="12">
            <span class="risk-count-badge" style="display:none;">0</span>
        </div>
        <div class="heatmap-cell high" id="cell-3-5" data-score="15">
            <span class="risk-count-badge" style="display:none;">0</span>
        </div>
        
        <!-- Row 2: Unlikely -->
        <div class="heatmap-cell label">
            <div>2</div>
            <small>Unlikely</small>
        </div>
        <div class="heatmap-cell low" id="cell-2-1" data-score="2">
            <span class="risk-count-badge" style="display:none;">0</span>
        </div>
        <div class="heatmap-cell low" id="cell-2-2" data-score="4">
            <span class="risk-count-badge" style="display:none;">0</span>
        </div>
        <div class="heatmap-cell medium" id="cell-2-3" data-score="6">
            <span class="risk-count-badge" style="display:none;">0</span>
        </div>
        <div class="heatmap-cell medium" id="cell-2-4" data-score="8">
            <span class="risk-count-badge" style="display:none;">0</span>
        </div>
        <div class="heatmap-cell high" id="cell-2-5" data-score="10">
            <span class="risk-count-badge" style="display:none;">0</span>
        </div>
        
        <!-- Row 1: Rare -->
        <div class="heatmap-cell label">
            <div>1</div>
            <small>Rare</small>
        </div>
        <div class="heatmap-cell low" id="cell-1-1" data-score="1">
            <span class="risk-count-badge" style="display:none;">0</span>
        </div>
        <div class="heatmap-cell low" id="cell-1-2" data-score="2">
            <span class="risk-count-badge" style="display:none;">0</span>
        </div>
        <div class="heatmap-cell low" id="cell-1-3" data-score="3">
            <span class="risk-count-badge" style="display:none;">0</span>
        </div>
        <div class="heatmap-cell medium" id="cell-1-4" data-score="4">
            <span class="risk-count-badge" style="display:none;">0</span>
        </div>
        <div class="heatmap-cell medium" id="cell-1-5" data-score="5">
            <span class="risk-count-badge" style="display:none;">0</span>
        </div>
    </div>
    
    <div class="heatmap-legend">
        <strong>Likelihood</strong> (vertical axis) Ã— <strong>Impact</strong> (horizontal axis)
    </div>
</div>

<!-- Filters -->
<div class="filter-card">
    <form method="GET" class="filter-form">
        <div class="filter-group">
            <label>Status</label>
            <select name="status" class="filter-select" onchange="this.form.submit()">
                <option value="">All Status</option>
                <option value="Compliant" {% if request.GET.status == 'Compliant' %}selected{% endif %}>Compliant</option>
                <option value="Non-Compliant" {% if request.GET.status == 'Non-Compliant' %}selected{% endif %}>Non-Compliant</option>
            </select>
        </div>

        <div class="filter-group">
            <label>Compliance Level</label>
            <select name="compliance" class="filter-select" onchange="this.form.submit()">
                <option value="">All Levels</option>
                <option value="high" {% if request.GET.compliance == 'high' %}selected{% endif %}>High (80-100%)</option>
                <option value="medium" {% if request.GET.compliance == 'medium' %}selected{% endif %}>Medium (50-79%)</option>
                <option value="low" {% if request.GET.compliance == 'low' %}selected{% endif %}>Low (0-49%)</option>
            </select>
        </div>

        {% if request.GET.status or request.GET.compliance %}
        <a href="{% url 'risk_register' %}" class="btn-clear">
            <i class="fas fa-times"></i> Clear Filters
        </a>
        {% endif %}
    </form>
</div>

<!-- ConMon Requirements Table -->
<div class="table-container">
    <div style="margin-bottom: 16px;">
        <h2 style="font-size: 20px; font-weight: 600; color: #1d1d1f; margin-bottom: 4px;">ConMon Requirements</h2>
        <p style="font-size: 14px; color: #86868b;">{{ risks|length }} requirements found</p>
    </div>

    <table class="data-table">
        <thead>
            <tr>
                <th>NAME</th>
                <th>COMPLIANCE</th>
                <th>STATUS</th>
                <th>OWNER</th>
                <th>ACTIONS</th>
            </tr>
        </thead>
        <tbody>
            {% for risk in risks %}
            <tr>
                <td>
                    <strong>{{ risk.title }}</strong>
                    {% if risk.description %}
                    <br><small style="color: #86868b;">{{ risk.description|truncatewords:20 }}</small>
                    {% endif %}
                </td>
                <td>
                    <div class="compliance-bar-container">
                        <div class="compliance-bar {% if risk.compliance_percentage >= 80 %}high{% elif risk.compliance_percentage >= 50 %}medium{% else %}low{% endif %}" 
                             style="width: {{ risk.compliance_percentage }}%;">
                            {{ risk.compliance_percentage }}%
                        </div>
                    </div>
                </td>
                <td>
                    {% if risk.compliance_percentage >= 80 %}
                    <span class="status-badge-compliant">
                        <i class="fas fa-check-circle"></i> Compliant
                    </span>
                    {% else %}
                    <span class="status-badge-noncompliant">
                        <i class="fas fa-times-circle"></i> Non-Compliant
                    </span>
                    {% endif %}
                </td>
                <td>{{ risk.owner.username|default:"Unassigned" }}</td>
                <td>
                    <div class="action-buttons">
                        <a href="{% url 'risk_update' risk.pk %}" class="btn-icon" title="Edit Requirement">
                            <i class="fas fa-edit"></i>
                        </a>
                        <a href="{% url 'risk_delete' risk.pk %}" class="btn-icon btn-icon-danger" title="Delete Requirement">
                            <i class="fas fa-trash"></i>
                        </a>
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="5" style="text-align: center; padding: 40px;">
                    <i class="fas fa-clipboard-list" style="font-size: 48px; color: #d1d1d6; margin-bottom: 16px;"></i>
                    <p style="color: #86868b;">No ConMon requirements found.</p>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
// Populate heatmap with risk data
document.addEventListener('DOMContentLoaded', function() {
    const risks = {{ risks_json|safe }};
    
    // Count risks in each cell
    const cellCounts = {};
    
    risks.forEach(risk => {
        const likelihood = risk.likelihood;
        const impact = risk.impact;
        const cellId = `cell-${likelihood}-${impact}`;
        
        if (!cellCounts[cellId]) {
            cellCounts[cellId] = 0;
        }
        cellCounts[cellId]++;
    });
    
    // Update heatmap cells with counts
    Object.keys(cellCounts).forEach(cellId => {
        const cell = document.getElementById(cellId);
        if (cell) {
            const badge = cell.querySelector('.risk-count-badge');
            if (badge) {
                badge.textContent = cellCounts[cellId];
                badge.style.display = 'block';
            }
        }
    });
});
</script>
{% endblock %}